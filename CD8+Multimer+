# set seed and install libraries
set.seed(123)
library(flowCore)
library(flowViz)
library(flowVS)
library(flowAI)
library(PeacoQC)
library(CATALYST)
library(CytoNorm)
library(SingleCellExperiment)
library(uwot)
library(knitr)
library(xlsx)
library("flowCore")
library("flowCut")
library(ggcyto)

#directories

setwd("~/Regina/IVA")

fcs.dir<- file.path(getwd(), "02_data/patient_2_3/Multimer") 
fcs_data <- read.flowSet(path=fcs.dir, pattern="*.fcs", transformation = FALSE, truncate_max_range = FALSE)


# data frame of the panel

fcs_colname <- colnames(fcs_data)
marker_class <- rep("none", ncol(fcs_data[[1]]))
marker_type <- c(8:28,31:43)
marker_class[marker_type] <- "type" # markers that indicate surface markers, such as CD3, CD4, or markers that you do want to use for clustering
marker_class <- factor(marker_class, levels=c("type", "none"))
antigen <- pData(parameters(fcs_data[[1]]))$desc

panel <- data.frame(fcs_colname, antigen, marker_class, row.names = NULL)
write.xlsx(panel, file="C:/Users/Admin/Documents/Regina/IVA/04_exports/panel.xlsx", sheetName="Panel")


#creating the metadata
files <- list.files("./02_data/patient_2_3/Multimer", 
                    pattern = "fcs",
                    full.names = TRUE)
file_name <- fsApply(fcs_data, identifier)
md <- data.frame(file_name = file_name)
md$sample_id <- gsub("\\.fcs", "", basename(md$file_name))
md$patient <- sapply(strsplit(md$sample_id, " - "), function(x) x[1])
md$experiment <- sapply(strsplit(md$sample_id, " - "), function(x) x[2])
md$cells <- sapply(strsplit(md$sample_id, " - "), function(x) x[3])
md$experiment_cells <- paste(md$experiment, md$cells, sep = "_")
rownames(md)  <- NULL
kable(md)

fcs_data <- fcs_data[c(1,3,5,7,9,11)] #only total CD8+ cells
md <- md[c(1,3,5,7,9,11),] #only total CD8+ cells
markerstotransform <- panel$fcs_colname[c(8:28,31:43)] 

#inspect the data to decide which type of transformation suits better
expression_data <- fcs_data[[1]]
expression_data <- expression_data@exprs


#tranform the data with FlowVS
cofactors <- readRDS(file = "C:/Users/Admin/Documents/Regina/IVA/04_exports/cofactors.rds")
cofactordata <- data.frame(markerstotransform, cofactors)

fcs_transform <- transFlowVS(fcs_data, channels = markerstotransform, cofactors)
filenames <- sampleNames(fcs_data)
sampleNames(fcs_transform) <- filenames

# Loop for the QC by flowCut
for (i in 1:6) {
  file_name <- basename(fcs_transform[[i]]@description$FILENAME)
  # Apply the flowCut function for each sample
  res_flowCut <- flowCut(fcs_transform[[i]], FileID = file_name, Plot = "All", Segment = 1000)
  
  # Optionally, print the result or save it
  print(paste("Results for sample", i))
  print(res_flowCut$data)
  
}

Subsampling_FlowSet <- function(x, fraction, md){
  b <- round(fraction*length(x), digits=0)
  
  listq <- sample(x=length(x), b, replace=FALSE)
  listq <- sort(listq)
  
  fcs_train<-x[c(listq)]
  
  md_train <- md[c(listq),]
  
  
  fcs_train <<- fcs_train
  md_train <<- md_train
  
  listy <- 1:length(x)
  
  listz <- subset(listy, !(listy %in% listq))
  
  listz <- sort(listz)
  
  fcs_test <- x[c(listz)]
  
  md_test <- md[c(listz),]
  
  fcs_test <<- fcs_test
  md_test <<- md_test
  
}

Subsampling_FlowSet(fcs_transform, 0.25, md=md) #test and train set are created

#train set

sce_train <- prepData(fcs_train, md=md_train, panel= panel, FACS = TRUE, transform=FALSE, md_cols =list(file="file_name", id="patient", factors=c("cells", "experiment", "experiment_cells")))
assayNames(sce_train)[1] <- "exprs"

exprs_train <- assay(sce_train, "exprs")
exprs_train <- t(exprs_train)
exprs_train <- exprs_train[,c(marker_type)] #markers you want to use for clustering, you can also use marker_state or marker_type

set.seed(1234)

umap_train <- uwot::umap(exprs_train, n_neighbors=100, min_dist = 0.5, ret_model = TRUE)
reducedDim(sce_train, "UMAP")<- umap_train$embedding

#add test set

sce_test <-prepData(fcs_test, md=md_test, panel= panel, FACS = TRUE, transform=FALSE, md_cols =list(file="file_name", id="patient", factors=c("cells", "experiment", "experiment_cells")))
assayNames(sce_test)[1] <- "exprs"

exprs_test <- assay(sce_test, "exprs")
exprs_test <- t(exprs_test)
exprs_test <- exprs_test[,c(marker_type)]

umap_test <- uwot::umap_transform(exprs_test, umap_train)

reducedDim(sce_train, "UMAP")<- NULL

umap_total <- rbind(umap_train$embedding, umap_test)

sce_total <- cbind(sce_train, sce_test)

reducedDim(sce_total, "UMAP") <- umap_total

#Mapping of multimer+ cells on UMAP
exprs_data <- sce_total@assays@data$exprs
colData(sce_total)$Gating <- ifelse( exprs_data[31,] >= 1.5,"Multimer+", "Non-multimer")

plotDR(sce_total, "UMAP", color_by = "Gating")

#Subset Multimer+ cells in a separate object
sce_multimer <- sce_total[,sce_total@colData$Gating =="Multimer+"]

#Multimer+ cells 

exprs_multimer <- assay(sce_multimer, "exprs")
exprs_multimer <- t(exprs_multimer)
exprs_multimer <- exprs_multimer[,c(marker_type)] #markers you want to use for clustering, you can also use marker_state or marker_type


set.seed(7460)
umap <- umap(exprs_multimer, n_neighbors=50, min_dist = 0.5, ret_model = TRUE)
reducedDim(sce_multimer, "UMAP")<- umap$embedding


#Clustering data

# Create a list to store filtered flowFrames
filtered_flowFrames <- list()

# Iterate through each sample in the flowSet
for (i in seq_along(fcs_transform@frames)) {
  exprs_data <- exprs(fcs_transform[[i]])
  gating_results <- exprs_data[, 31] >= 1.5  # Logical vector for "Multimer+"
  filtered_data <- exprs_data[gating_results, ]
  filtered_flowFrame <- flowFrame(exprs = filtered_data, description = description(fcs_transform[[i]]))
                                  filtered_flowFrames[[i]] <- filtered_flowFrame
}

names(filtered_flowFrames) <- sampleNames(fcs_transform)
# Combine the list of filtered flowFrames into a new flowSet
filtered_flowSet <- flowSet(filtered_flowFrames)
pData(filtered_flowSet) <- pData(fcs_transform)



sce_multimer<- prepData(filtered_flowSet, md=md, panel= panel, FACS = TRUE, transform=FALSE, md_cols =list(file="file_name", id="patient", factors=c("cells", "experiment", "experiment_cells")))

assayNames(sce_multimer)[1] <- "exprs"
sce_multimer <- cluster(sce_multimer, features="type", maxK=8, seed=7460)

sce_multimer <- runDR(sce_multimer, "UMAP", n_neighbors=100 , min_dist = 0.5, features = "type")

saveRDS(sce_multimer, file = "C:/Users/Admin/Documents/Regina/IVA/04_exports/sce_multimer.rds")
sce_multimer <- readRDS(file = "C:/Users/Admin/Documents/Regina/IVA/04_exports/sce_multimer.rds")

plotDR(sce_multimer, "UMAP", color_by="meta8")
plotDR(sce_multimer, "UMAP", color_by="sample_id")
plotDR(sce_multimer, "UMAP", color_by="experiment")
plotDR(sce_multimer, "UMAP", color_by="CD26")
plotDR(sce_multimer, "UMAP", color_by="CD73")
plotDR(sce_multimer, "UMAP", color_by="CCR7")
plotDR(sce_multimer, "UMAP", color_by="TIGIT")
plotDR(sce_multimer, "UMAP", color_by="CD39")
plotDR(sce_multimer, "UMAP", color_by="CD40L")
plotDR(sce_multimer, "UMAP", color_by="meta8", facet_by = "experiment")
plotDR(sce_multimer, "UMAP", color_by="meta8", facet_by = "sample_id")

